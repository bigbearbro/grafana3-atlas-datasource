{"version":3,"sources":["../src/datasource.js"],"names":["angular","_","dateMath","kbn","AtlasDatasource","instanceSettings","$q","backendSrv","templateSrv","type","url","name","q","atlasFormat","minimumInterval","query","_this","urlPath","replaceWithText","datasourceRequest","method","headers","then","mapToTextValue","result","map","data","d","i","text","value","options","target","tag","queries","shouldUpdate","stepNumber","stepUnit","targets","forEach","hide","rawQuery","rawQueryInput","rawQueryParts","rawQueryReplaced","push","alias","legend","join","groupBys","filter","groupBy","length","queryParts","hasPushAggregation","tags","logicals","len","aTag","valueReplaced","includes","replace","multipleValues","split","mvIndex","mvLen","matcher","notCondition","logical","aggregation","concat","reverse","aliasLegend","legendSuffixValue","isNaN","alert","fullQuery","interval","interval_to_ms","secondsToHms","console","log","params","step","s","range","from","valueOf","e","to","format","httpOptions","inspect","deferred","defer","response","status","error","Error","reject","responseError","resolve","convertToTimeseries","message","promise","timeseriesData","index","series","datapoints","indexOf","allIsNull","values","notAllZero","notAllNull","timestamp","start","undefined","allIsZero","title"],"mappings":"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","file":"datasource.js","sourcesContent":["import angular from \"angular\";\nimport _ from \"lodash\";\nimport dateMath from \"app/core/utils/datemath\";\nimport kbn from \"app/core/utils/kbn\";\n\nexport class AtlasDatasource {\n\n    constructor(instanceSettings, $q, backendSrv, templateSrv) {\n        this.type = instanceSettings.type;\n        this.url = instanceSettings.url;\n        this.name = instanceSettings.name;\n        this.q = $q;\n        this.backendSrv = backendSrv;\n        this.templateSrv = templateSrv;\n        this.atlasFormat = instanceSettings.atlasFormat || 'std.json';\n        this.minimumInterval = instanceSettings.minimumInterval || 1000;\n    }\n\n    // Required for templating\n    metricFindQuery(query) {\n      var _this = this;\n      // default is to get tags from atlas\n      let urlPath = '/api/v1/tags/name';\n      // if we see a string as the query, this is a template query, otherwise it is a normal query\n      if (typeof(query) === \"string\") {\n        // TODO: support multiple tag queries\n        //\n        urlPath = '/api/v1/' + _this.templateSrv.replaceWithText(query);\n      }\n      // TODO: support multiple tags: Change this to a Promise.all\n      return this.backendSrv.datasourceRequest({\n        url: this.url + urlPath,\n        method: 'GET',\n        headers: {\n          'Content-Type': 'application/json',\n        }\n      }).then(this.mapToTextValue);\n    }\n\n    mapToTextValue(result) {\n        return _.map(result.data, (d, i) => {\n            return {\n                text: d,\n                value: i\n            };\n        });\n    }\n\n    metricFindDimensions(options) {\n        return this.backendSrv.datasourceRequest({\n            url: this.url + '/api/v1/tags?q=name,' + options.target + ',:eq',\n            data: options,\n            method: 'GET',\n            headers: {\n                'Content-Type': 'application/json',\n            }\n        }).then(this.mapToTextValue);\n    }\n\n    dimensionFindValues(options, tag) {\n        return this.backendSrv.datasourceRequest({\n            url: this.url + '/api/v1/tags/' + tag,\n            data: options,\n            method: 'GET',\n            headers: {\n                'Content-Type': 'application/json',\n            }\n        }).then(this.mapToTextValue);\n    }\n\n    query(options) {\n        var queries = [];\n        var shouldUpdate = false;\n        //only set the first time through\n        if (this.stepNumber == null){\n            this.stepNumber = 0;\n        }\n        if (this.stepUnit == null){\n            this.stepUnit = '';\n        }\n        var _this = this;\n        // var _scopeTags = _this.templateSrv.variables;\n        options.targets.forEach(function(target) {\n            if (target.hide || !(target.rawQuery || target.target)) {\n                return;\n            }\n            if (target.rawQueryInput) {\n                if (!target.rawQuery) {\n                    return;\n                }\n                var rawQueryParts = [];\n                // replace template variables inside the rawQuery\n                let rawQueryReplaced = _this.templateSrv.replaceWithText(target.rawQuery);\n                rawQueryParts.push(rawQueryReplaced);\n                if (target.alias) {\n                    var legend = target.alias;\n                    rawQueryParts.push(legend);\n                    rawQueryParts.push(':legend');\n                }\n                queries.push(rawQueryParts.join(','));\n            }\n            else {\n                if (!target.target) {\n                    return;\n                }\n                if (target.groupBys) {\n                    target.groupBys = target.groupBys.filter(function(groupBy) {\n                        return groupBy.name && groupBy.name.length > 0;\n                    });\n                }\n                var queryParts = [];\n                queryParts.push(\"name,\" + target.target + \",:eq\");\n\n                /*\n                  This is for multi-value selection from templateSrv, not supported right now...\n\n                if (_scopeTags) {\n                  for (var i = 0; i < _scopeTags.length; i++) {\n                    if (_scopeTags[i].current.text != 'All') {\n                      var x = _scopeTags[i];\n                      queryParts.push(_scopeTags[i].name + \",\" + _scopeTags[i].current.text + \",:eq,:and\");\n                    }\n                  }\n                }\n                */\n                var hasPushAggregation = false;\n\n                if (target.tags) {\n                    var logicals = [];\n                    for (let i = 0, len = target.tags.length; i < len; i++) {\n                      var aTag = target.tags[i];\n                      var valueReplaced = _this.templateSrv.replaceWithText(aTag.value);\n                      // the replaced value for templates will be a comma separated list\n                      if (valueReplaced.includes(',')) {\n                          len = valueReplaced.length;\n                          valueReplaced = valueReplaced.replace('{','');\n                          valueReplaced = valueReplaced.replace('}','');\n                          var multipleValues = valueReplaced.split(',');\n                          for (var mvIndex = 0, mvLen = multipleValues.length; mvIndex < mvLen; mvIndex++) {\n                            // queryParts.push(aTag.name);\n                            if (\"xxxin\" === aTag.matcher) {\n                              //if (target.aggregation) {\n                              //    queryParts.push(\":\" + target.aggregation);\n                              //}\n                              queryParts.push(aTag.name);\n                              queryParts.push(\"(\");\n                              queryParts.push(multipleValues[mvIndex]);\n                              queryParts.push(\")\");\n                              queryParts.push(\":in\");\n                            }\n                            else {\n                              queryParts.push(aTag.name);\n                              queryParts.push(multipleValues[mvIndex]);\n                              queryParts.push(\":\" + aTag.matcher);\n                            }\n                            if (\"not\" === aTag.notCondition) {\n                                queryParts.push(\":not\");\n                            }\n                            logicals.push(\":\" + aTag.logical);\n                          }\n                      } else {\n                        // queryParts.push(aTag.name);\n                        if (\"in\" === aTag.matcher) {\n                          // no logicals associated with this matcher\n\n                          // legend must come before this matcher\n                          // aggregation must come before this matcher, so the name must be pushed after\n                          if (target.aggregation) {\n                            hasPushAggregation = true;\n                            queryParts.push(\":\" + target.aggregation);\n                          }\n                          queryParts.push(aTag.name);\n                          queryParts.push(\"(\");\n                          queryParts.push(valueReplaced);\n                          queryParts.push(\")\");\n                          queryParts.push(\":in\");\n                        }\n                        else {\n                          queryParts.push(aTag.name);\n                          queryParts.push(valueReplaced);\n                          queryParts.push(\":\" + aTag.matcher);\n                        }\n                        if (\"not\" === aTag.notCondition) {\n                            queryParts.push(\":not\");\n                        }\n                        if (\"in\" === aTag.matcher) {\n                           // logicals go before \"in\"\n                        } else {\n                          logicals.push(\":\" + aTag.logical);\n                        }\n                      }\n                    }\n                    queryParts = queryParts.concat(logicals.reverse());\n                }\n\n                if (target.aggregation && !hasPushAggregation) {\n                  queryParts.push(\":\" + target.aggregation);\n                }\n                if (target.groupBys && target.groupBys.length > 0) {\n                    queryParts.push(\"(\");\n                    target.groupBys.forEach(function(groupBy) {\n                        queryParts.push(groupBy.name);\n                    });\n                    queryParts.push(\")\");\n                    queryParts.push(\":by\");\n                }\n\n                if (target.alias) {\n                    var aliasLegend = target.alias;\n                    if (target.groupBys && target.groupBys.length > 0) {\n                        var legendSuffixValue = _.map(target.groupBys,\n                                function(groupBy) {\n                                    return ' $' + groupBy.name;\n                                })\n                            .join(' ');\n                        aliasLegend += ' ' + legendSuffixValue;\n                    }\n                    queryParts.push(aliasLegend);\n                    queryParts.push(':legend');\n                }\n                queries.push(queryParts.join(','));\n            }\n            if (isNaN(target.stepNumber) && target.stepNumber != null){\n                alert(\"Only numbers are valid for the Step Size field\");\n            }\n            if (target.stepNumber != null && target.stepNumber != this.stepNumber){\n                this.stepNumber = target.stepNumber;\n                shouldUpdate = true;\n            }\n            if (target.stepUnit != null && target.stepUnit != this.stepUnit){\n                this.stepUnit = target.stepUnit;\n                shouldUpdate = true;\n            }\n            if (shouldUpdate){\n                if (this.stepUnit == null || this.stepUnit === ''){\n                    this.stepUnit = 'm';\n                }\n                options.targets.forEach(function(target) {\n                    target.stepNumber = this.stepNumber;\n                    target.stepUnit = this.stepUnit;\n                },this);\n            }\n\n        },this);\n        // Atlas can take multiple concatenated stack queries\n        var fullQuery = queries.join(',');\n        var interval = '1m';\n        if (this.stepNumber === 0){\n            interval = options.interval;\n        }\n        else{\n            //update all the other targets so that they are all the same\n            //console.log(\"step unit =\" + this.stepUnit);\n            interval = this.stepNumber+this.stepUnit;\n        }\n        //console.log(\"options interval = \" + interval );\n        if (kbn.interval_to_ms(interval) < this.minimumInterval) {\n            // console.log(\"Detected interval smaller than allowed: \" + interval);\n            interval = kbn.secondsToHms(this.minimumInterval / 1000);\n            // console.log(\"New Interval: \" + interval);\n        }\n        console.log(\"interval after min check = \" + interval );\n\n        /*\n                var params = {\n                    q: fullQuery,\n                    step: interval,\n                    s: options.rangeRaw.from,\n                    e: options.rangeRaw.to,\n                    format: this.atlasFormat\n                };\n        */\n\n        var params = {\n            q: fullQuery,\n            step: interval,\n            s: options.range.from.valueOf(),\n            e: options.range.to.valueOf(),\n            format: this.atlasFormat\n        };\n\n        var httpOptions = {\n            method: 'GET',\n            url: this.url + '/api/v1/graph',\n            params: params,\n            headers: {\n                'Content-Type': 'application/json',\n            },\n            inspect: {\n                type: 'atlas'\n            }\n        };\n        // console.log(\"before defer\");\n        var deferred = this.q.defer();\n        // var _this = this;\n        this.backendSrv.datasourceRequest(httpOptions)\n            .then(function(response) {\n                if (response.status !== 200) {\n                    console.log(\"error...\");\n                    var error = new Error(\"Bad Status: \" + response.status);\n                    deferred.reject(error);\n                }\n                if (!response.data) {\n                    var responseError = new Error(\"No data\");\n                    deferred.reject(responseError);\n                }\n                deferred.resolve(_this.convertToTimeseries(response.data));\n            }, function(response) {\n                console.error('Unable to load data. Response: %o', response.data ? response.data.message : response);\n                var error = new Error(\"Unable to load data\");\n                deferred.reject(error);\n            });\n\n        return deferred.promise;\n    }\n\n    convertToTimeseries(result) {\n        // console.log(\"inside convertToTimeseries\");\n        var timeseriesData = _.map(result.legend, function(legend, index) {\n            var series = {\n                target: legend,\n                datapoints: []\n            };\n            if (legend.indexOf('NO DATA') > 0 || legend.indexOf('NO_DATA') > 0) {\n                series.allIsNull = true;\n                return series;\n            }\n\n            var values = _.map(result.values, index);\n\n            var notAllZero = false;\n            var notAllNull = false;\n            for (var i = 0; i < values.length; i++) {\n                var value = values[i];\n                // convert any NaN to nulls so the graph panel will connect them\n                if (value === \"NaN\") {\n                    value = null;\n                }\n                var timestamp = result.start + (i * result.step);\n                series.datapoints.push([value, timestamp]);\n                notAllZero = notAllZero || value !== 0;\n                notAllNull = notAllNull || (value !== \"NaN\" && value !== undefined);\n            }\n            //hide zero and null results\n            series.allIsZero = !notAllZero;\n            series.allIsNull = !notAllNull;\n            return series;\n        });\n        return {\n            data: timeseriesData\n        };\n    }\n\n    // Required\n    // Used for testing datasource in datasource configuration pange\n    testDatasource() {\n        return this.backendSrv.datasourceRequest({\n            url: this.url + '/api/v1/tags',\n            method: 'GET',\n        }).then(response => {\n            if (response.status === 200) {\n                return {\n                    status: \"success\",\n                    message: \"Data source is working\",\n                    title: \"Success\"\n                };\n            }\n        });\n    }\n}\n"]}